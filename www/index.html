<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
        font-src https://fonts.gstatic.com; 
        img-src 'self' data: https://thesustainabilitymanager.com http://thesustainabilitymanager.com; 
        connect-src 'none';
        media-src https://thesustainabilitymanager.com;">
    <title>Stress Fighter</title>
    <!-- Preload the battle background image -->
    <link rel="preload" href="https://thesustainabilitymanager.com/background.png" as="image">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --glow-cyan: 0 0 5px #06b6d4, 0 0 10px #06b6d4, 0 0 20px #06b6d4;
            --glow-yellow: 0 0 5px #facc15, 0 0 10px #facc15, 0 0 20px #facc15;
            --glow-red: 0 0 5px #f87171, 0 0 10px #f87171, 0 0 20px #f87171;
            --sf-yellow: #F7D71E;
            --sf-red: #D73B28;
            --sf-blue: #2875D7;
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Nunito', sans-serif;
            background: #111827;
            color: #f0f0f0;
            padding-top: env(safe-area-inset-top);
        }
        .font-pixel {
            font-family: 'Press Start 2P', cursive;
        }
        .screen {
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }
        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
        }
        .text-glow-yellow { text-shadow: var(--glow-yellow); }
        .text-glow-cyan { text-shadow: var(--glow-cyan); }
        .btn-modern {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            transform: translateY(0);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-modern:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: all 0.4s;
        }
        .btn-modern:hover:before { left: 100%; }
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-modern:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary {
            background-image: linear-gradient(to right, #2563eb, #3b82f6);
            box-shadow: 0 4px 15px 0 rgba(59, 130, 246, 0.3);
        }
        .btn-secondary {
            background-image: linear-gradient(to right, #4b5563, #6b7280);
            box-shadow: 0 4px 15px 0 rgba(107, 114, 128, 0.3);
        }
        .sf-health-bars {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 8px;
            background: linear-gradient(to bottom, #1f2937, #374151);
            border-bottom: 4px solid #4b5563;
        }
        .sf-bar-container {
            height: 20px;
            width: 40%;
            background-color: #111827;
            border: 2px solid #f0f0f0;
            padding: 2px;
        }
        .sf-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        #composureBar.sf-bar { background-color: var(--sf-yellow); }
        #stressBar.sf-bar { background-color: var(--sf-red); }
        .sf-timer {
            font-family: 'Press Start 2P', cursive;
            color: var(--sf-yellow);
            font-size: 1.5rem;
        }
        .opponent-card {
            background-color: rgba(31, 41, 55, 0.7);
            border: 2px solid #4b5563;
            border-radius: 12px;
            transition: all 0.2s ease-in-out;
            backdrop-filter: blur(4px);
            position: relative;
        }
        .opponent-card:hover {
            transform: translateY(-5px);
            border-color: #06b6d4;
            box-shadow: var(--glow-cyan);
        }
        .hint-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--sf-yellow);
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: linear-gradient(135deg, #1f2937, #374151);
            border-radius: 16px;
            border: 2px solid #4b5563;
        }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .character-container {
            display: flex;
            justify-content: center;
            align-items: flex-end; /* This is the change */
            height: 100%;
            width: 100%;
            position: relative; 
        }
        .character-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.2s ease-in-out, opacity 1s ease-in-out;
        }
        .damage-number {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Press Start 2P', cursive;
            font-size: 1.5rem;
            animation: floatUp 1s ease-out forwards;
        }
        .damage-stress { color: var(--sf-red); }
        .damage-composure { color: var(--sf-yellow); }
        .secret-technique-glow {
             box-shadow: var(--glow-yellow);
        }
        select.custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        #gardenContainer {
            width: 100%;
            max-width: 600px;
            height: 60%;
            background-color: #374151;
            border: 4px solid #4b5563;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        .garden-item {
            position: absolute;
            transition: opacity 0.5s ease-in-out;
            opacity: 0.2; /* Locked by default */
        }
        .garden-item.unlocked { opacity: 1; }
        .garden-item.golden { filter: drop-shadow(0 0 10px gold); }
        #garden-stream { bottom: 10%; left: 5%; width: 90%; height: 20%; background-color: #60a5fa; border-radius: 15px; } /* Placeholder */
        #garden-bonsai { bottom: 30%; left: 15%; width: 100px; height: 120px; background-color: #84cc16; } /* Placeholder */
        #garden-lantern { bottom: 30%; right: 15%; width: 60px; height: 100px; background-color: #78716c; } /* Placeholder */
        #perfectRoundBanner {
            display: none;
            font-family: 'Press Start 2P', cursive;
            color: gold;
            text-shadow: 0 0 10px gold;
            margin-bottom: 1rem;
        }
        #arenaBattleground {
            background-image: url('https://thesustainabilitymanager.com/background.png');
            background-size: cover;
            background-position: center bottom; /* This is the change */
        }

        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes flash { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(2); } }
        @keyframes floatUp { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -50px); } }
        @keyframes tranquil-glow { 
            from { filter: brightness(1) drop-shadow(0 0 0 white); } 
            50% { filter: brightness(1.5) drop-shadow(0 0 10px white); }
            to { filter: brightness(1) drop-shadow(0 0 0 white); }
        }
        .tranquil-sequence { animation: tranquil-glow 2s ease-out forwards; }
    </style>
</head>
<body class="w-full h-screen flex items-center justify-center">

    <div id="screenContainer" class="w-full h-full flex items-center justify-center bg-gray-900">
    
        <div id="splashScreen" class="screen bg-gray-900 cursor-pointer" onclick="initApp()">
            <h1 class="font-pixel text-4xl md:text-5xl text-yellow-400 text-glow-yellow mb-4 text-center">Stress Fighter I</h1>
            <img src="https://thesustainabilitymanager.com/launch.png" alt="Stress Fighter Launch Image" class="max-w-xs md:max-w-md mx-auto">
            <p class="text-lg text-cyan-400 text-glow-cyan mt-8 animate-pulse">Tap to Start</p>
        </div>

        <div id="startScreen" class="screen hidden">
            <h1 class="font-pixel text-4xl md:text-6xl text-yellow-400 text-glow-yellow mb-4 text-center">Stress Fighter</h1>
            <p class="text-lg text-cyan-400 text-glow-cyan mb-8 text-center">Get a grip on chaos.</p>
            <div id="dailySecretContainer" class="text-center mb-6 hidden">
                <p class="text-yellow-400 font-bold">Sensei's Secret Technique:</p>
                <p id="dailySecretText" class="text-lg text-glow-yellow"></p>
            </div>
            <div class="space-y-4 flex flex-col items-center">
                <button onclick="playSound('click'); showScreen('selectOpponentScreen')" class="btn-modern btn-primary w-64">Start Fight</button>
                <button onclick="playSound('click'); showScreen('gardenScreen')" class="btn-modern btn-secondary w-64">Dojo Garden</button>
                <button onclick="playSound('click'); showHowToPlay()" class="btn-modern btn-secondary w-64">How to Play</button>
                <button onclick="playSound('click'); exitApp()" class="btn-modern btn-secondary w-64 bg-gray-700">Quit App</button>
            </div>
        </div>
        
        <div id="gardenScreen" class="screen hidden">
            <h2 class="font-pixel text-2xl md:text-3xl text-yellow-400 text-glow-yellow mb-6">Dojo Garden</h2>
            <div id="gardenContainer">
                <!-- Garden items will be populated here by JS -->
                <div id="garden-stream" class="garden-item"></div>
                <div id="garden-bonsai" class="garden-item"></div>
                <div id="garden-lantern" class="garden-item"></div>
            </div>
            <button onclick="playSound('click'); showScreen('startScreen')" class="btn-modern btn-secondary mt-8">Back to Menu</button>
        </div>

        <div id="selectOpponentScreen" class="screen hidden">
             <h2 class="font-pixel text-2xl md:text-3xl text-yellow-400 text-glow-yellow mb-6 text-center">Choose Your Opponent</h2>
             <p class="mb-8 text-cyan-400 text-center">What does your stress feel like today?</p>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl">
                <div onclick="playSound('click'); selectOpponent('anxiety')" class="opponent-card p-4 cursor-pointer">
                    <div class="hint-icon" onclick="event.stopPropagation(); showHint('anxiety')">?</div>
                    <div class="monster-container h-32 flex items-center justify-center"></div>
                    <h3 class="font-pixel text-xl text-red-400 mt-4">Anxious Assassin</h3>
                    <p class="text-sm mt-2 text-gray-300">Racing thoughts & worry about the future.</p>
                </div>
                <div onclick="playSound('click'); selectOpponent('burnout')" class="opponent-card p-4 cursor-pointer">
                    <div class="hint-icon" onclick="event.stopPropagation(); showHint('burnout')">?</div>
                    <div class="monster-container h-32 flex items-center justify-center"></div>
                    <h3 class="font-pixel text-xl text-red-400 mt-4">Exhausted Brute</h3>
                    <p class="text-sm mt-2 text-gray-300">Heavy exhaustion & emotional depletion.</p>
                </div>
                <div onclick="playSound('click'); selectOpponent('anger')" class="opponent-card p-4 cursor-pointer">
                    <div class="hint-icon" onclick="event.stopPropagation(); showHint('anger')">?</div>
                    <div class="monster-container h-32 flex items-center justify-center"></div>
                    <h3 class="font-pixel text-xl text-red-400 mt-4">Raging Brawler</h3>
                    <p class="text-sm mt-2 text-gray-300">Frustration, irritation & explosive feelings.</p>
                </div>
            </div>
            <button onclick="playSound('click'); showScreen('startScreen')" class="btn-modern btn-secondary mt-12">Back</button>
        </div>

        <div id="arenaScreen" class="screen hidden !justify-start p-0">
            <div class="sf-health-bars">
                <div class="sf-bar-container">
                    <div id="composureBar" class="sf-bar" style="width: 100%;"></div>
                </div>
                <div class="sf-timer">VS</div>
                <div class="sf-bar-container">
                    <div id="stressBar" class="sf-bar" style="width: 100%;"></div>
                </div>
            </div>
            <div id="arenaBattleground" class="flex-grow flex justify-between items-center p-2 md:p-6 w-full">
                <div id="playerCharacter" class="character-container w-1/2 h-full"></div>
                <div id="monsterCharacter" class="character-container w-1/2 h-full"></div>
            </div>
            <div id="moveList" class="grid grid-cols-3 gap-2 w-full p-2 bg-gray-900">
                <button id="tech-zenBreath" onclick="playSound('click'); showTechnique('zenBreath')" class="btn-modern btn-secondary text-xs p-2">Zen Breath</button>
                <button id="tech-grounding" onclick="playSound('click'); showTechnique('grounding')" class="btn-modern btn-secondary text-xs p-2">5-4-3-2-1</button>
                <button id="tech-reframing" onclick="playSound('click'); showTechnique('reframing')" class="btn-modern btn-secondary text-xs p-2">Mind Shift</button>
                <button id="tech-tensionTakedown" onclick="playSound('click'); showTechnique('tensionTakedown')" class="btn-modern btn-secondary text-xs p-2">Tension Takedown</button>
                <button id="tech-serenitySanctuary" onclick="playSound('click'); showTechnique('serenitySanctuary')" class="btn-modern btn-secondary text-xs p-2">Serenity Sanctuary</button>
                <button onclick="playSound('click'); takeABreak()" class="btn-modern bg-yellow-600 hover:bg-yellow-500 text-xs p-2">Take a Break</button>
            </div>
        </div>

        <div id="victoryScreen" class="screen hidden">
            <h2 class="font-pixel text-4xl text-yellow-400 text-glow-yellow mb-6">TRANQUILITY</h2>
            <h3 id="perfectRoundBanner">PERFECT ROUND!</h3>
            <div id="tamedMonsterContainer" class="h-48 w-48 mx-auto my-4 character-container"></div>
            <p class="text-cyan-400 mb-8">You have calmed the storm. The stress is now at peace.</p>
            <div id="strategyLog" class="w-full max-w-md mx-auto mt-8 text-left">
                 <h3 class="font-pixel text-lg text-yellow-400 mb-4 text-center">Post-Fight Strategy Log</h3>
                <label for="triggerSelect" class="text-sm mb-2 block text-center">What was the specific trigger for this feeling?</label>
                <select id="triggerSelect" class="w-full p-2 bg-gray-700 border-2 border-gray-500 text-white mb-4 rounded-md custom-select">
                    <option value="Work or School Deadline">Work or School Deadline</option>
                    <option value="Difficult Conversation">Difficult Conversation</option>
                    <option value="Financial Worry">Financial Worry</option>
                    <option value="Health Concern">Health Concern</option>
                    <option value="Feeling Overwhelmed">Feeling Overwhelmed</option>
                    <option value="Other">Other</option>
                </select>
                <label for="intensitySlider" class="text-sm mb-2 block text-center">How intense was it at the start? <span id="intensityValue">5</span>/10</label>
                <input type="range" id="intensitySlider" min="1" max="10" value="5" class="w-full mb-4">
                <label for="strategySelect" class="text-sm mb-2 block text-center">What is one small action you can take to prepare for next time?</label>
                 <select id="strategySelect" class="w-full p-2 bg-gray-700 border-2 border-gray-500 text-white mb-4 rounded-md custom-select">
                    <option value="Take a 5-minute walk">Take a 5-minute walk</option>
                    <option value="Listen to a favorite song">Listen to a favorite song</option>
                    <option value="Talk to a friend">Talk to a friend</option>
                    <option value="Write down my thoughts">Write down my thoughts</option>
                    <option value="Do one small, manageable task">Do one small, manageable task</option>
                </select>
                <button onclick="playSound('click'); getSenseiFeedback('win')" class="btn-modern btn-primary w-full mb-2">✨ Get Sensei's Feedback</button>
                <button onclick="playSound('click'); saveReportAndReturn()" class="btn-modern btn-secondary w-full">Save & Return to Menu</button>
            </div>
        </div>
        <div id="gaveUpScreen" class="screen hidden">
            <h2 class="font-pixel text-4xl text-red-500" style="text-shadow: var(--glow-red);">OVERWHELMED</h2>
            <p class="text-cyan-400 mb-8">It's okay to retreat. Rest and try again when you're ready.</p>
            <button onclick="playSound('click'); getSenseiFeedback('loss')" class="btn-modern btn-primary w-64 mb-2">✨ Get Sensei's Wisdom</button>
            <button onclick="playSound('click'); showScreen('startScreen')" class="btn-modern btn-secondary w-64">Return to Menu</button>
        </div>
    </div>
    
    <div id="techniqueModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div id="modalContent" class="modal-content w-11/12 max-w-lg text-center relative p-8"></div>
    </div>
    
    <div id="senseiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="modal-content w-11/12 max-w-lg text-center relative p-8">
            <h3 id="senseiModalTitle" class="font-pixel text-2xl text-yellow-400 mb-4">Sensei's Wisdom</h3>
            <div id="senseiWisdomText" class="text-cyan-300 min-h-[100px]"></div>
            <button onclick="playSound('click'); closeSenseiModal()" class="btn-modern btn-secondary mt-6">Close</button>
        </div>
    </div>
    
    <script>
        // --- DOM element references ---
        const screenContainer = document.getElementById('screenContainer');
        const techniqueModal = document.getElementById('techniqueModal');
        const modalContent = document.getElementById('modalContent');
        const senseiModal = document.getElementById('senseiModal');
        const senseiModalTitle = document.getElementById('senseiModalTitle');
        const senseiWisdomText = document.getElementById('senseiWisdomText');
        const composureBar = document.getElementById('composureBar');
        const stressBar = document.getElementById('stressBar');
        const playerCharacter = document.getElementById('playerCharacter');
        const monsterCharacter = document.getElementById('monsterCharacter');
        const intensitySlider = document.getElementById('intensitySlider');
        const intensityValue = document.getElementById('intensityValue');
        const dailySecretContainer = document.getElementById('dailySecretContainer');
        const dailySecretText = document.getElementById('dailySecretText');
        const perfectRoundBanner = document.getElementById('perfectRoundBanner');

        // --- State variables ---
        let stressLevel = 100, composureLevel = 100;
        let currentOpponent = '', currentScreen = 'splashScreen', currentOpponentName = '';
        let audioStarted = false, appInitialized = false;
        let secretTechnique = { id: '', name: '' };
        let gameData = {};
        let isPerfectRoundPossible = true;
        
        const defaultGameData = {
            garden: {
                anxiety: { unlocked: false, golden: false },
                burnout: { unlocked: false, golden: false },
                anger: { unlocked: false, golden: false }
            }
        };

        const characterImages = {
            player: 'https://thesustainabilitymanager.com/player.png',
            anxiety: 'https://thesustainabilitymanager.com/anxious%20assassin.png',
            burnout: 'https://thesustainabilitymanager.com/Exhauster%20brute.png',
            anger: 'https://thesustainabilitymanager.com/Raging%20brawler.png',
            'player-victory': 'https://thesustainabilitymanager.com/player-victory.png',
            'anxiety-calm': 'https://thesustainabilitymanager.com/anxious-assassin-calm.png',
            'burnout-calm': 'https://thesustainabilitymanager.com/exhauster-brute-calm.png',
            'anger-calm': 'https://thesustainabilitymanager.com/raging-brawler-calm.png'
        };
        const opponentNames = { anxiety: "Anxious Assassin", burnout: "Exhausted Brute", anger: "Raging Brawler" };
        const techniques = [
            { id: 'zenBreath', name: 'Zen Breath' },
            { id: 'grounding', name: '5-4-3-2-1' },
            { id: 'reframing', name: 'Mind Shift' },
            { id: 'tensionTakedown', name: 'Tension Takedown' },
            { id: 'serenitySanctuary', name: 'Serenity Sanctuary' }
        ];

        const opponentWeaknesses = {
            anxiety: 'grounding',
            burnout: 'serenitySanctuary',
            anger: 'zenBreath'
        };
        const hintMessages = {
            anxiety: "Sensei's Hint: The Anxious Assassin thrives on future worries. Anchor yourself in the present to calm it.",
            burnout: "Sensei's Hint: The Exhausted Brute is a heavy burden. True rest and inner peace are its weakness.",
            anger: "Sensei's Hint: The Raging Brawler is fueled by rapid, shallow breaths. Slow your breathing to slow its heart."
        };

        // --- Audio Setup ---
        let battleMusic; // Declare here, initialize after Tone.start()
        const sounds = {
            'click': new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
            'hit': new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' } }).toDestination(),
            'win': new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 1 } }).toDestination(),
            'lose': new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.2, release: 1 } }).toDestination()
        };
        const tenseAmbience = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 5, decay: 0.1, sustain: 1 } });
        tenseAmbience.volume.value = -40; // very quiet
        const calmAmbience = new Tone.Synth({ oscillator: { type: 'fatsine' }, envelope: { attack: 5, decay: 0.1, sustain: 1 } });
        calmAmbience.volume.value = -40;
        
        // --- Pre-generated AI Content ---
        const cannedResponses = {
            reframing: [
                "• Instead of 'I will fail,' try 'This is challenging, but I can handle it.'\n• What if this is an opportunity to learn, not just a test to pass?\n• It's okay to not be perfect. My best effort is enough.",
                "• This feels overwhelming now, but feelings are temporary.\n• I have overcome difficult things before. I have the strength to get through this too.\n• What is one small, manageable step I can take right now?",
                "• Is this thought 100% true? Or is it just my anxiety talking?\n• A more balanced view is that there are things I can control and things I can't. I will focus on what I can control.\n• I will be kind to myself, no matter the outcome."
            ],
            senseiWin: [
                "An excellent strategy. To plan for the storm while the sea is calm is the mark of a true master. Carry this foresight with you, and you will find peace is always within reach.",
                "Well done. You have not only calmed the storm but also learned from it. Each challenge you overcome forges greater inner strength. Remember this feeling of balance.",
                "A wise plan. By preparing for the trigger, you take away its power. Continue this practice of mindful preparation, and you will become unshakable."
            ],
            senseiLoss: [
                "Even the strongest warrior must rest. To recognize your limits is a sign of wisdom, not weakness. Recover your strength. The challenge will be there when you are ready to face it again.",
                "Do not be discouraged. The path to inner peace has many steps. You have learned something valuable today. Rest, reflect, and return with new understanding."
            ]
        };

        function getRandomItem(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // --- Game Data Functions (localStorage) ---
        function loadGameData() {
            const savedData = localStorage.getItem('stressFighterGameData');
            gameData = savedData ? JSON.parse(savedData) : defaultGameData;
        }

        function saveGameData() {
            localStorage.setItem('stressFighterGameData', JSON.stringify(gameData));
        }

        function renderGarden() {
            if (!gameData.garden) return;
            const stream = document.getElementById('garden-stream');
            const bonsai = document.getElementById('garden-bonsai');
            const lantern = document.getElementById('garden-lantern');

            if (gameData.garden.anxiety.unlocked) stream.classList.add('unlocked');
            if (gameData.garden.burnout.unlocked) bonsai.classList.add('unlocked');
            if (gameData.garden.anger.unlocked) lantern.classList.add('unlocked');

            if (gameData.garden.anxiety.golden) stream.classList.add('golden');
            if (gameData.garden.burnout.golden) bonsai.classList.add('golden');
            if (gameData.garden.anger.golden) lantern.classList.add('golden');
        }

        function updateAmbience() {
            if (!audioStarted) return;
            if (stressLevel > 70) {
                tenseAmbience.triggerAttack();
                calmAmbience.triggerRelease();
            } else if (stressLevel < 30) {
                tenseAmbience.triggerRelease();
                calmAmbience.triggerAttack('C2');
            } else {
                tenseAmbience.triggerRelease();
                calmAmbience.triggerRelease();
            }
        }

        function setSecretTechnique() {
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const tech = techniques[dayOfYear % techniques.length];
            secretTechnique = tech;
            dailySecretText.textContent = tech.name;
            dailySecretContainer.classList.remove('hidden');
        }

        function initApp() {
            if (appInitialized) return;
            appInitialized = true;
            loadGameData();
            showScreen('startScreen');
            setSecretTechnique();
            Tone.start().then(() => { 
                audioStarted = true;
                // Initialize audio nodes after user interaction
                battleMusic = new Tone.Player({
                    url: "https://thesustainabilitymanager.com/battle.wav",
                    loop: true,
                    volume: -10,
                    onload: () => {
                        console.log("Battle music loaded.");
                    }
                }).toDestination();
                tenseAmbience.toDestination();
                calmAmbience.toDestination();
             }).catch(e => console.error("Audio could not be started:", e));
        }

        function playSound(sound) {
            if (!audioStarted) { initApp(); return; }
            switch(sound) {
                case 'click': sounds.click.triggerAttackRelease('C4', '8n'); break;
                case 'hit': sounds.hit.triggerAttackRelease('C2', '8n'); break;
                case 'win':
                    sounds.win.triggerAttackRelease('C5', '8n', Tone.now());
                    sounds.win.triggerAttackRelease('E5', '8n', Tone.now() + 0.2);
                    sounds.win.triggerAttackRelease('G5', '8n', Tone.now() + 0.4);
                    break;
                case 'lose': sounds.lose.triggerAttackRelease('C3', '4n'); break;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadGameData();
            playerCharacter.innerHTML = `<img src="${characterImages.player}" class="character-img" alt="Player Character">`;
            document.querySelectorAll('#selectOpponentScreen .monster-container').forEach(container => {
                const card = container.closest('.opponent-card');
                let opponentType = '';
                if (card.onclick.toString().includes('anxiety')) opponentType = 'anxiety';
                else if (card.onclick.toString().includes('burnout')) opponentType = 'burnout';
                else if (card.onclick.toString().includes('anger')) opponentType = 'anger';
                if (opponentType) container.innerHTML = `<img src="${characterImages[opponentType]}" class="character-img" alt="${opponentNames[opponentType]}">`;
            });
            intensitySlider.addEventListener('input', (event) => {
                intensityValue.textContent = event.target.value;
            });
            renderGarden();
        });

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            if (screenId === 'gardenScreen') {
                renderGarden();
            }
            if (screenId !== 'arenaScreen' && battleMusic && battleMusic.state === 'started') {
                battleMusic.stop();
            }
            currentScreen = screenId;
        }

        function selectOpponent(opponentType) {
            currentOpponent = opponentType;
            currentOpponentName = opponentNames[opponentType];
            
            playerCharacter.innerHTML = `<img src="${characterImages.player}" class="character-img" alt="Player Character">`;
            monsterCharacter.innerHTML = `<img src="${characterImages[opponentType]}" class="character-img" alt="${opponentNames[opponentType]}">`;
            
            document.querySelectorAll('#moveList button').forEach(btn => btn.classList.remove('secret-technique-glow'));
            document.getElementById(`tech-${secretTechnique.id}`)?.classList.add('secret-technique-glow');
            
            isPerfectRoundPossible = true;
            stressLevel = 100; composureLevel = 100;
            updateBars();
            showScreen('arenaScreen');
            if (audioStarted && battleMusic) {
                if (battleMusic.loaded) {
                    if (battleMusic.state !== 'started') battleMusic.start();
                } else {
                    battleMusic.onload = () => {
                         if (currentScreen === 'arenaScreen' && battleMusic.state !== 'started') {
                            battleMusic.start();
                        }
                    };
                }
            }
        }
        
        function showImpact(target, value) {
            const container = target === 'player' ? playerCharacter : monsterCharacter;
            const characterImg = container.querySelector('.character-img');
            const damageNumber = document.createElement('div');
            if (target === 'player') {
                damageNumber.className = 'damage-number damage-composure';
                damageNumber.textContent = `+${Math.round(value)}`;
                characterImg.classList.add('flash-effect');
            } else {
                damageNumber.className = 'damage-number damage-stress';
                damageNumber.textContent = `-${Math.round(value)}`;
                characterImg.classList.add('shake-effect');
            }
            container.appendChild(damageNumber);
            setTimeout(() => {
                damageNumber.remove();
                characterImg.classList.remove('shake-effect', 'flash-effect');
            }, 1000);
        }

        function triggerFinishingMove() {
            if (battleMusic && battleMusic.state === 'started') battleMusic.stop();
            playSound('win');
            document.getElementById('moveList').style.pointerEvents = 'none';
            const monsterImg = monsterCharacter.querySelector('.character-img');
            const playerImg = playerCharacter.querySelector('.character-img');

            if (isPerfectRoundPossible) {
                perfectRoundBanner.style.display = 'block';
                gameData.garden[currentOpponent].golden = true;
            } else {
                perfectRoundBanner.style.display = 'none';
            }
            gameData.garden[currentOpponent].unlocked = true;
            saveGameData();

            monsterImg.src = characterImages[`${currentOpponent}-calm`];
            playerImg.src = characterImages['player-victory'];
            
            monsterImg.classList.add('tranquil-sequence');

            setTimeout(() => {
                document.getElementById('tamedMonsterContainer').innerHTML = `<img src="${characterImages[currentOpponent + '-calm']}" class="character-img" alt="${opponentNames[currentOpponent]} Tamed">`;
                showScreen('victoryScreen');
                document.getElementById('moveList').style.pointerEvents = 'auto';
            }, 2500);
        }

        function updateBars(isFinalMove = false) {
            stressLevel = Math.max(0, stressLevel);
            composureLevel = Math.min(100, composureLevel);
            stressBar.style.width = `${stressLevel}%`;
            composureBar.style.width = `${composureLevel}%`;
            updateAmbience();

            if (composureLevel < 90) {
                isPerfectRoundPossible = false;
            }

            if (isFinalMove && stressLevel <= 0) {
                triggerFinishingMove();
            }
        }

        function completeMove(damage, composureBoost, techniqueId) {
            if (techniqueId === opponentWeaknesses[currentOpponent]) {
                damage *= 2; // Super-effective!
            }
             if (techniqueId === secretTechnique.id) {
                damage *= 1.5;
                composureBoost *= 1.5;
            }

            playSound('hit');
            showImpact('monster', damage);
            showImpact('player', composureBoost);
            
            const isFinalMove = (stressLevel - damage) <= 0;
            stressLevel -= damage;
            composureLevel += composureBoost;

            setTimeout(() => updateBars(isFinalMove), 300);
            closeModal();
        }

        function showFeelingCheckIn(damage, composureBoost, techniqueId) {
             modalContent.innerHTML = `
                <h3 class="font-pixel text-2xl text-yellow-400 mb-4">Check In</h3>
                <p class="mb-6 text-lg">Take a breath. Notice how you feel after that exercise.</p>
                <button onclick="completeMove(${damage}, ${composureBoost}, '${techniqueId}')" class="btn-modern btn-primary mt-6">Continue</button>
            `;
        }
        
        function startGroundingExercise() {
            const steps = [
                "<strong>5:</strong> Name five things you can <strong>see</strong> around you.",
                "<strong>4:</strong> Name four things you can <strong>feel</strong> (e.g., your feet on the floor).",
                "<strong>3:</strong> Name three things you can <strong>hear</strong> right now.",
                "<strong>2:</strong> Name two things you can <strong>smell</strong>.",
                "<strong>1:</strong> Name one thing you can <strong>taste</strong>."
            ];
            let currentStep = 0;
            function updateStep() {
                if (currentStep < steps.length) {
                    modalContent.innerHTML = `
                        <h3 class="font-pixel text-2xl text-yellow-400 mb-4">5-4-3-2-1 Grounding</h3>
                        <p class="mb-6 text-lg">${steps[currentStep]}</p>
                        <button onclick="nextGroundingStep()" class="btn-modern btn-primary mt-6">Next</button>`;
                } else {
                    showFeelingCheckIn(25, 10, 'grounding');
                }
            }
            window.nextGroundingStep = () => { currentStep++; updateStep(); };
            updateStep();
        }

        function showTechnique(techniqueId) {
            let content = '';
            techniqueModal.classList.remove('hidden');
            switch (techniqueId) {
                case 'zenBreath':
                    content = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">Zen Breath</h3>
                        <p class="mb-6">Follow the rhythm. Breathe in, hold, breathe out, hold.</p>
                        <div id="breathAnimator" class="w-24 h-24 bg-cyan-400 mx-auto rounded-full transition-transform duration-[4000ms] ease-in-out"></div>
                        <p id="breathText" class="mt-4 text-lg">Get Ready...</p>
                        <button onclick="playSound('click'); closeModal()" class="btn-modern btn-secondary mt-6">Cancel</button>`;
                    modalContent.innerHTML = content;
                    startBreathingExercise();
                    break;
                case 'grounding': startGroundingExercise(); break;
                case 'reframing':
                     content = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">Mind Shift</h3>
                        <p class="mb-4">Take a negative thought you're having.</p>
                        <textarea id="negativeThoughtInput" class="w-full bg-gray-700 p-2 border-2 border-gray-500 rounded-md" rows="2" placeholder="e.g., 'I will fail this test.'"></textarea>
                        <button id="reframeBtn" onclick="playSound('click'); getReframingSuggestions()" class="btn-modern btn-primary my-4 w-full">✨ Get Suggestions</button>
                        <div id="reframedSuggestions" class="text-left text-sm space-y-2 bg-gray-900/50 p-3 rounded-md min-h-[100px]"></div>
                        <button onclick="showFeelingCheckIn(30, 15, 'reframing')" class="btn-modern btn-secondary mt-6">Done</button>`;
                    modalContent.innerHTML = content;
                    break;
                case 'tensionTakedown':
                     content = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">Tension Takedown</h3>
                        <p class="mb-6">Systematically tense for 5s, then release each muscle group.</p>
                        <div class="text-left space-y-2 text-sm">
                            <p><strong>1. Feet & Calves:</strong> Curl your toes, then release.</p>
                            <p><strong>2. Thighs:</strong> Squeeze your thigh muscles, then release.</p>
                            <p><strong>3. Hands & Arms:</strong> Make a fist and flex, then release.</p>
                            <p><strong>4. Shoulders & Neck:</strong> Shrug your shoulders, then release.</p>
                            <p><strong>5. Face:</strong> Scrunch your face, then release.</p>
                        </div>
                        <button onclick="showFeelingCheckIn(35, 20, 'tensionTakedown')" class="btn-modern btn-primary mt-6">Complete</button>`;
                    modalContent.innerHTML = content;
                    break;
                case 'serenitySanctuary':
                     content = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">Serenity Sanctuary</h3>
                        <p class="mb-6">Close your eyes. Imagine a place where you feel completely safe and calm...</p>
                        <ul class="list-disc list-inside text-left mx-auto max-w-xs">
                            <li>What do you see?</li>
                            <li>What do you hear?</li>
                            <li>What do you smell?</li>
                            <li>What do you feel?</li>
                        </ul>
                        <button onclick="showFeelingCheckIn(40, 25, 'serenitySanctuary')" class="btn-modern btn-primary mt-6">I'm Back</button>`;
                    modalContent.innerHTML = content;
                    break;
            }
        }
        
        function startBreathingExercise() {
            const animator = document.getElementById('breathAnimator');
            const text = document.getElementById('breathText');
            if (!animator || !text) return;
            let isModalOpen = true;
            const modalObserver = new MutationObserver(() => {
                if (techniqueModal.classList.contains('hidden')) isModalOpen = false;
            });
            modalObserver.observe(techniqueModal, { attributes: true, attributeFilter: ['class'] });
            let cycle = 0;
            const states = ['Breathe In...', 'Hold...', 'Breathe Out...', 'Hold...'];
            const scales = [1.5, 1.5, 1, 1];
            function runCycle() {
                if (isModalOpen) {
                    text.innerText = states[cycle % 4];
                    animator.style.transform = `scale(${scales[cycle % 4]})`;
                    cycle++;
                    setTimeout(runCycle, 4000);
                }
            }
            setTimeout(() => {
                if (!techniqueModal.classList.contains('hidden')) {
                    runCycle();
                    setTimeout(() => {
                      if (!techniqueModal.classList.contains('hidden')) showFeelingCheckIn(20, 5, 'zenBreath');
                    }, 17000);
                }
            }, 1000); 
        }

        function closeModal() {
            techniqueModal.classList.add('hidden');
            modalContent.innerHTML = '';
        }
        
        function closeSenseiModal() { senseiModal.classList.add('hidden'); senseiWisdomText.innerHTML = ''; }

        function takeABreak() {
            modalContent.innerHTML = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">Take a Break?</h3>
                <p class="mb-6">It's okay to step away and return when you're ready. Would you like to end this session for now?</p>
                <div class="flex justify-center gap-4">
                    <button onclick="playSound('click'); closeModal()" class="btn-modern btn-secondary">Stay</button>
                    <button onclick="playSound('lose'); showScreen('gaveUpScreen'); closeModal();" class="btn-modern btn-primary">End Session</button>
                </div>`;
            techniqueModal.classList.remove('hidden');
        }
        
        function showHowToPlay() {
             modalContent.innerHTML = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">How to Play</h3>
                <div class="text-left space-y-4">
                  <p>1. Identify your feeling and choose the corresponding Opponent.</p>
                  <p>2. Your <span class="text-yellow-400">Composure</span> is top left; the <span class="text-red-400">Stress</span> level is top right.</p>
                  <p>3. Use the techniques as your moves. Each is a real exercise to lower Stress and raise Composure.</p>
                  <p>4. Your goal is to lower the Stress level to zero to find Tranquility.</p>
                </div>
                <button onclick="playSound('click'); closeModal()" class="btn-modern btn-secondary mt-6">Got It</button>`;
            techniqueModal.classList.remove('hidden');
        }

        function saveReportAndReturn() {
            const trigger = document.getElementById('triggerSelect').value;
            const intensity = document.getElementById('intensitySlider').value;
            const strategy = document.getElementById('strategySelect').value;
            console.log('Session Logged:', { opponent: currentOpponentName, trigger, intensity, strategy });
            showScreen('startScreen');
        }

        function exitApp() {
            try { 
                Capacitor.Plugins.App.exitApp(); 
            } catch (e) { 
                console.log("ExitApp not available in browser. Returning to splash screen.");
                showScreen('splashScreen');
            }
        }
        
        function showHint(opponentType) {
            modalContent.innerHTML = `<h3 class="font-pixel text-xl text-yellow-400 mb-4">Scouting Report</h3>
                <p class="text-cyan-300">${hintMessages[opponentType]}</p>
                <button onclick="playSound('click'); closeModal()" class="btn-modern btn-secondary mt-6">Understood</button>`;
            techniqueModal.classList.remove('hidden');
        }

        function getReframingSuggestions() {
            const suggestionsDiv = document.getElementById('reframedSuggestions');
            const reframeBtn = document.getElementById('reframeBtn');
            reframeBtn.disabled = true;
            reframeBtn.innerHTML = '<span class="loader"></span>';

            setTimeout(() => {
                const response = getRandomItem(cannedResponses.reframing);
                suggestionsDiv.innerHTML = response.replace(/\•/g, '<p class="mb-1">•');
                reframeBtn.disabled = false;
                reframeBtn.innerHTML = '✨ Get Suggestions';
            }, 500); // Simulate AI thinking
        }
        
        function getSenseiFeedback(outcome) {
            senseiModal.classList.remove('hidden');
            senseiWisdomText.innerHTML = '<div class="flex justify-center items-center"><span class="loader"></span></div>';
            
            setTimeout(() => {
                let response;
                if (outcome === 'win') {
                    senseiModalTitle.innerText = "Sensei's Feedback";
                    response = getRandomItem(cannedResponses.senseiWin);
                } else { // loss
                    senseiModalTitle.innerText = "Sensei's Wisdom";
                    response = getRandomItem(cannedResponses.senseiLoss);
                }
                senseiWisdomText.innerText = response;
            }, 500); // Simulate AI thinking
        }
    </script>
</body>
</html>

