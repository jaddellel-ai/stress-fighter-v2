<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Stress Fighter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --glow-cyan: 0 0 5px #06b6d4, 0 0 10px #06b6d4, 0 0 20px #06b6d4;
            --glow-yellow: 0 0 5px #facc15, 0 0 10px #facc15, 0 0 20px #facc15;
            --glow-red: 0 0 5px #f87171, 0 0 10px #f87171, 0 0 20px #f87171;
        }
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #111827, #1f2937);
            color: #f0f0f0;
            overscroll-behavior: contain;
            /* Safe area padding for mobile notches/status bars */
            padding-top: env(safe-area-inset-top);
        }
        .font-pixel {
            font-family: 'Press Start 2P', cursive;
        }
        .screen {
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
        }
        .text-glow-yellow {
            text-shadow: var(--glow-yellow);
        }
        .text-glow-cyan {
            text-shadow: var(--glow-cyan);
        }
        .btn-modern {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            transform: translateY(0);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-modern:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: all 0.4s;
        }
        .btn-modern:hover:before {
            left: 100%;
        }
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-modern:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-image: linear-gradient(to right, #2563eb, #3b82f6);
            box-shadow: 0 4px 15px 0 rgba(59, 130, 246, 0.3);
        }
        .btn-secondary {
            background-image: linear-gradient(to right, #4b5563, #6b7280);
            box-shadow: 0 4px 15px 0 rgba(107, 114, 128, 0.3);
        }
        .health-bar-container {
            border: 2px solid #4b5563;
            border-radius: 8px;
            padding: 4px;
            background-color: rgba(17, 24, 39, 0.5);
            position: relative;
        }
        .health-bar {
            height: 24px;
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .health-bar-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 2px black;
        }
        #composureBar { background: linear-gradient(to right, #16a34a, #4ade80); }
        #stressBar { background: linear-gradient(to right, #dc2626, #f87171); }
        .opponent-card {
            background-color: rgba(31, 41, 55, 0.7);
            border: 2px solid #4b5563;
            border-radius: 12px;
            transition: all 0.2s ease-in-out;
            backdrop-filter: blur(4px);
        }
        .opponent-card:hover {
            transform: translateY(-5px);
            border-color: #06b6d4;
            box-shadow: var(--glow-cyan);
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: linear-gradient(135deg, #1f2937, #374151);
            border-radius: 16px;
            border: 2px solid #4b5563;
        }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="w-full h-screen flex items-center justify-center p-4">

    <!-- Screen Container for transitions -->
    <div id="screenContainer" class="w-full h-full flex items-center justify-center">

        <!-- Screen: Start -->
        <div id="startScreen" class="screen text-center">
            <h1 class="font-pixel text-4xl md:text-6xl text-yellow-400 text-glow-yellow mb-4">Stress Fighter</h1>
            <p class="text-lg text-cyan-400 text-glow-cyan mb-8">Get a grip on chaos.</p>
            <div class="space-y-4">
                <button onclick="playSound('click'); showScreen('selectOpponentScreen')" class="btn-modern btn-primary w-64">Start Fight</button>
                <button onclick="playSound('click'); showScreen('dojoScreen')" class="btn-modern btn-secondary w-64">Enter Dojo</button>
                <button onclick="playSound('click'); exitApp()" class="btn-modern btn-secondary w-64 bg-gray-700">Session Complete</button>
            </div>
        </div>

        <!-- Screen: Select Opponent -->
        <div id="selectOpponentScreen" class="screen hidden text-center">
            <h2 class="font-pixel text-3xl md:text-4xl text-yellow-400 text-glow-yellow mb-6">Choose Your Opponent</h2>
            <p class="mb-8 text-cyan-400">What does your stress feel like?</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl">
                <div onclick="playSound('click'); selectOpponent('anxiety')" class="opponent-card p-4 cursor-pointer">
                    <div class="monster-container h-32 flex items-center justify-center"></div>
                    <h3 class="font-pixel text-xl text-red-400 mt-4">Anxious Assassin</h3>
                    <p class="text-sm mt-2 text-gray-300">Racing thoughts & worry about the future.</p>
                </div>
                <div onclick="playSound('click'); selectOpponent('burnout')" class="opponent-card p-4 cursor-pointer">
                    <div class="monster-container h-32 flex items-center justify-center"></div>
                    <h3 class="font-pixel text-xl text-red-400 mt-4">Exhausted Brute</h3>
                    <p class="text-sm mt-2 text-gray-300">Heavy exhaustion & emotional depletion.</p>
                </div>
                <div onclick="playSound('click'); selectOpponent('anger')" class="opponent-card p-4 cursor-pointer">
                    <div class="monster-container h-32 flex items-center justify-center"></div>
                    <h3 class="font-pixel text-xl text-red-400 mt-4">Raging Brawler</h3>
                    <p class="text-sm mt-2 text-gray-300">Frustration, irritation & explosive feelings.</p>
                </div>
            </div>
            <button onclick="playSound('click'); showScreen('startScreen')" class="btn-modern btn-secondary mt-12">Back</button>
        </div>

        <!-- Screen: Arena -->
        <div id="arenaScreen" class="screen hidden w-full max-w-4xl mx-auto">
            <!-- Health Bars -->
            <div class="flex flex-col md:flex-row justify-between gap-4 mb-4">
                <div class="w-full">
                    <h2 class="font-pixel mb-2 text-green-400">COMPOSURE</h2>
                    <div class="health-bar-container">
                        <div id="composureBar" class="health-bar"></div>
                        <span id="composureText" class="health-bar-text">100%</span>
                    </div>
                </div>
                <div class="w-full">
                    <h2 class="font-pixel mb-2 text-red-400 text-right">STRESS LEVEL</h2>
                    <div class="health-bar-container">
                        <div id="stressBar" class="health-bar"></div>
                        <span id="stressText" class="health-bar-text">100%</span>
                    </div>
                </div>
            </div>

            <!-- Characters -->
            <div class="flex-grow flex justify-between items-center bg-gray-900/50 p-2 md:p-6 rounded-lg border-2 border-gray-700 mb-4 w-full">
                <div id="playerCharacter" class="character w-1/3 h-full">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="h-full w-full object-contain">
                        <g fill-rule="evenodd">
                            <path d="M50 30 C 40 30, 40 40, 50 40 S 60 30, 50 30 Z" fill="#F3F4F6"/>
                            <path d="M42 40 L 58 40 L 55 60 L 45 60 Z" fill="#60A5FA"/>
                            <path d="M45 60 L 55 60 L 58 85 L 42 85 Z" fill="#F3F4F6"/>
                            <path d="M50 95 C 45 95, 45 85, 40 85 L 60 85 C 55 85, 55 95, 50 95 Z" fill="#9CA3AF"/>
                            <rect x="35" y="45" width="5" height="20" fill="#F3F4F6"/>
                            <rect x="60" y="45" width="5" height="20" fill="#F3F4F6"/>
                            <rect x="40" y="58" width="20" height="4" fill="#1F2937"/>
                        </g>
                    </svg>
                </div>
                <div id="monsterCharacter" class="character w-1/3 h-full"></div>
            </div>

            <!-- Move List -->
            <div id="moveList" class="grid grid-cols-2 md:grid-cols-3 gap-4 w-full">
                <button onclick="playSound('click'); showTechnique('zenBreath')" class="btn-modern btn-secondary">Zen Breath</button>
                <button onclick="playSound('click'); showTechnique('grounding')" class="btn-modern btn-secondary">5-4-3-2-1</button>
                <button onclick="playSound('click'); showTechnique('reframing')" class="btn-modern btn-secondary">Mind Shift</button>
                <button onclick="playSound('click'); showTechnique('tensionTakedown')" class="btn-modern btn-secondary">Tension Takedown</button>
                <button onclick="playSound('click'); showTechnique('serenitySanctuary')" class="btn-modern btn-secondary">Serenity Sanctuary</button>
                <button onclick="playSound('click'); giveUp()" class="btn-modern bg-red-700 hover:bg-red-600">Give Up</button>
            </div>
        </div>

        <!-- Screen: Dojo -->
        <div id="dojoScreen" class="screen hidden w-full max-w-2xl text-center">
            <h2 class="font-pixel text-3xl text-yellow-400 text-glow-yellow mb-6">The Dojo</h2>
            <div class="border-2 border-cyan-400/50 rounded-lg bg-gray-800/50 text-left p-6 mb-8">
                <p class="text-cyan-300 mb-4 text-center text-lg">"Welcome, warrior. Stress is not an enemy to be destroyed, but a force to be understood and tamed. Here, we train the mind and body to find calm in the chaos."</p>
                <p class="text-right">- Sensei Kai</p>
            </div>
            <div class="space-y-4 text-left">
                <div class="border-2 border-gray-600 rounded-lg p-4 bg-gray-800/50">
                    <h3 class="font-pixel text-lg text-yellow-400 mb-2">Zen Breath</h3>
                    <p class="text-sm text-gray-300">A technique to calm your nervous system. Inhale for 4s, hold for 4s, exhale for 4s, hold for 4s. It breaks the panic cycle.</p>
                </div>
                <div class="border-2 border-gray-600 rounded-lg p-4 bg-gray-800/50">
                    <h3 class="font-pixel text-lg text-yellow-400 mb-2">5-4-3-2-1 Grounding</h3>
                    <p class="text-sm text-gray-300">Pulls you out of anxious thoughts and into the present moment by focusing your senses on your environment.</p>
                </div>
                <div class="border-2 border-gray-600 rounded-lg p-4 bg-gray-800/50">
                    <h3 class="font-pixel text-lg text-yellow-400 mb-2">Mind Shift</h3>
                    <p class="text-sm text-gray-300">Challenge and change negative thought patterns. Ask: Is this thought 100% true? What's a more balanced perspective?</p>
                </div>
                 <div class="border-2 border-gray-600 rounded-lg p-4 bg-gray-800/50">
                    <h3 class="font-pixel text-lg text-yellow-400 mb-2">Tension Takedown</h3>
                    <p class="text-sm text-gray-300">Progressive Muscle Relaxation. By tensing and then releasing muscles, you learn to recognize and let go of physical tension.</p>
                </div>
                 <div class="border-2 border-gray-600 rounded-lg p-4 bg-gray-800/50">
                    <h3 class="font-pixel text-lg text-yellow-400 mb-2">Serenity Sanctuary</h3>
                    <p class="text-sm text-gray-300">Use your imagination to transport yourself to a safe, calm place. This creates a powerful internal feeling of peace.</p>
                </div>
            </div>
            <button onclick="playSound('click'); showScreen('startScreen')" class="btn-modern btn-secondary mt-8">Back to Menu</button>
        </div>

        <!-- Screen: Victory -->
        <div id="victoryScreen" class="screen hidden text-center">
            <h2 class="font-pixel text-4xl text-yellow-400 text-glow-yellow mb-6">TRANQUILITY</h2>
            <div id="tamedMonsterContainer" class="h-48 w-48 mx-auto my-4 opacity-70"></div>
            <p class="text-cyan-400 mb-8">You have calmed the storm. The stress is now at peace.</p>
            <div id="scoutingReport" class="w-full max-w-md mx-auto mt-8 text-left">
                <h3 class="font-pixel text-lg text-yellow-400 mb-4 text-center">Scouting Report</h3>
                <p class="text-sm mb-4 text-center">What triggered this fight?</p>
                <select id="triggerSelect" class="w-full p-2 bg-gray-700 border-2 border-gray-500 text-white mb-4 rounded-md">
                    <option value="work">Work / School</option>
                    <option value="family">Family / Relationships</option>
                    <option value="health">Health</option>
                    <option value="finances">Finances</option>
                    <option value="future">Worry about the future</option>
                    <option value="other">Other</option>
                </select>
                <button onclick="playSound('click'); getSenseiWisdom('win')" class="btn-modern btn-primary w-full mb-2">✨ Get Sensei's Wisdom</button>
                <button onclick="playSound('click'); saveReportAndReturn()" class="btn-modern btn-secondary w-full">Return to Menu</button>
            </div>
        </div>
        
        <!-- Screen: Gave Up -->
        <div id="gaveUpScreen" class="screen hidden text-center">
            <h2 class="font-pixel text-4xl text-red-500" style="text-shadow: var(--glow-red);">OVERWHELMED</h2>
            <p class="text-cyan-400 mb-8">It's okay to retreat. Rest and try again when you're ready.</p>
            <button onclick="playSound('click'); getSenseiWisdom('loss')" class="btn-modern btn-primary w-64 mb-2">✨ Get Sensei's Wisdom</button>
            <button onclick="playSound('click'); showScreen('startScreen')" class="btn-modern btn-secondary w-64">Return to Menu</button>
        </div>
    </div>

    <!-- Modal for Techniques -->
    <div id="techniqueModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div id="modalContent" class="modal-content w-11/12 max-w-lg text-center relative p-8">
            <!-- Content will be injected by JS -->
        </div>
    </div>
    
    <!-- Modal for Sensei's Wisdom -->
    <div id="senseiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="modal-content w-11/12 max-w-lg text-center relative p-8">
            <h3 class="font-pixel text-2xl text-yellow-400 mb-4">Sensei's Wisdom</h3>
            <div id="senseiWisdomText" class="text-cyan-300 min-h-[100px]">
                <!-- Wisdom will be injected here -->
            </div>
            <button onclick="playSound('click'); closeSenseiModal()" class="btn-modern btn-secondary mt-6">Close</button>
        </div>
    </div>

    <script>
        const screenContainer = document.getElementById('screenContainer');
        const techniqueModal = document.getElementById('techniqueModal');
        const modalContent = document.getElementById('modalContent');
        const senseiModal = document.getElementById('senseiModal');
        const senseiWisdomText = document.getElementById('senseiWisdomText');
        const composureBar = document.getElementById('composureBar');
        const stressBar = document.getElementById('stressBar');
        const composureText = document.getElementById('composureText');
        const stressText = document.getElementById('stressText');
        
        let stressLevel = 100;
        let composureLevel = 100;
        let currentOpponent = '';
        let currentScreen = 'startScreen';
        let currentOpponentName = '';
        let audioStarted = false;

        const monsterSVGs = {
            anxiety: `<svg viewBox="0 0 100 100" class="h-full w-full object-contain" xmlns="http://www.w3.org/2000/svg"><g fill="none" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M50 90 V 60 L 65 75 L 60 45 L 75 40 L 55 35 L 50 10 L 45 35 L 25 40 L 40 45 L 35 75 L 50 60 Z" stroke="#C7D2FE" fill="#4338CA"/><path d="M50 60 L 40 45 L 30 50 Z" stroke="#A5B4FC" fill="#6D28D9"/><path d="M50 60 L 60 45 L 70 50 Z" stroke="#A5B4FC" fill="#6D28D9"/><path d="M50 35 L 40 25 M60 25 L 50 35" stroke="#C7D2FE"/></g></svg>`,
            burnout: `<svg viewBox="0 0 100 100" class="h-full w-full object-contain" xmlns="http://www.w3.org/2000/svg"><g fill="#6B7280"><path d="M30 95 L 70 95 L 75 70 L 25 70 Z"/><path d="M35 70 L 65 70 L 60 40 L 40 40 Z"/><circle cx="50" cy="25" r="15"/><path d="M25 70 L 20 50 L 35 55 Z"/><path d="M75 70 L 80 50 L 65 55 Z"/></g><g fill="#4B5563"><path d="M48 22 L 52 22 L 52 28 L 48 28 Z"/><path d="M40 32 L 60 32 L 60 35 L 40 35 Z"/><path d="M30 95 L 35 70 L 25 70 Z"/><path d="M70 95 L 65 70 L 75 70 Z"/></g><path d="M50 50 L 40 40 M60 40 L 50 50" fill="none" stroke="#1F2937" stroke-width="2"/></svg>`,
            anger: `<svg viewBox="0 0 100 100" class="h-full w-full object-contain" xmlns="http://www.w3.org/2000/svg"><g><path d="M50 90 L 80 60 L 70 50 L 90 20 L 60 30 L 50 10 L 40 30 L 10 20 L 30 50 L 20 60 Z" fill="#F87171" stroke="#DC2626" stroke-width="3"/><path d="M50 70 L 65 55 L 50 40 L 35 55 Z" fill="#111827"/><path d="M40 40 L 60 40" stroke="white" stroke-width="4" stroke-linecap="round"/></g></svg>`
        };
        
        const opponentNames = {
            anxiety: "Anxious Assassin",
            burnout: "Exhausted Brute",
            anger: "Raging Brawler"
        };
        
        // --- Audio Setup ---
        const sounds = {
            'click': new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
            'hit': new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' } }).toDestination(),
            'win': new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 1 } }).toDestination(),
            'lose': new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.2, release: 1 } }).toDestination()
        };

        function playSound(sound) {
            if (!audioStarted) {
                Tone.start();
                audioStarted = true;
            }
            switch(sound) {
                case 'click':
                    sounds.click.triggerAttackRelease('C4', '8n');
                    break;
                case 'hit':
                    sounds.hit.triggerAttackRelease('C2', '8n');
                    break;
                case 'win':
                    sounds.win.triggerAttackRelease('C5', '8n', Tone.now());
                    sounds.win.triggerAttackRelease('E5', '8n', Tone.now() + 0.2);
                    sounds.win.triggerAttackRelease('G5', '8n', Tone.now() + 0.4);
                    break;
                 case 'lose':
                    sounds.lose.triggerAttackRelease('C3', '4n');
                    break;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('#selectOpponentScreen .monster-container').forEach(container => {
                const card = container.closest('.opponent-card');
                if (card.onclick.toString().includes('anxiety')) container.innerHTML = monsterSVGs.anxiety;
                else if (card.onclick.toString().includes('burnout')) container.innerHTML = monsterSVGs.burnout;
                else if (card.onclick.toString().includes('anger')) container.innerHTML = monsterSVGs.anger;
            });
            showScreen('startScreen', true);
        });

        function showScreen(screenId, instant = false) {
            const newScreen = document.getElementById(screenId);
            const oldScreen = document.getElementById(currentScreen);
            if (instant) {
                oldScreen.classList.add('hidden');
                newScreen.classList.remove('hidden');
            } else {
                oldScreen.classList.add('hidden');
                newScreen.classList.remove('hidden');
            }
            currentScreen = screenId;
        }

        function selectOpponent(opponentType) {
            currentOpponent = opponentType;
            currentOpponentName = opponentNames[opponentType];
            document.getElementById('monsterCharacter').innerHTML = monsterSVGs[opponentType];
            stressLevel = 100;
            composureLevel = 100;
            updateBars();
            showScreen('arenaScreen');
        }

        function updateBars() {
            stressLevel = Math.max(0, Math.round(stressLevel));
            composureLevel = Math.min(100, Math.round(composureLevel));
            stressBar.style.width = `${stressLevel}%`;
            stressText.innerText = `${stressLevel}%`;
            composureBar.style.width = `${composureLevel}%`;
            composureText.innerText = `${composureLevel}%`;
            if (stressLevel <= 0) {
                playSound('win');
                setTimeout(() => {
                    document.getElementById('tamedMonsterContainer').innerHTML = monsterSVGs[currentOpponent];
                    showScreen('victoryScreen');
                }, 500);
            }
        }

        function performMove(damage, composureBoost) {
            playSound('hit');
            stressLevel -= damage;
            composureLevel += composureBoost;
            updateBars();
            closeModal();
        }

        function showTechnique(technique) {
            let content = '';
            switch (technique) {
                case 'zenBreath':
                    content = `
                        <h3 class="font-pixel text-2xl text-yellow-400 mb-4">Zen Breath</h3>
                        <p class="mb-6">Follow the rhythm. Breathe in, hold, breathe out, hold.</p>
                        <div id="breathAnimator" class="w-24 h-24 bg-cyan-400 mx-auto rounded-full transition-transform duration-[4000ms] ease-in-out"></div>
                        <p id="breathText" class="mt-4 text-lg">Get Ready...</p>
                        <button onclick="playSound('click'); closeModal()" class="btn-modern btn-secondary mt-6">Cancel</button>
                    `;
                    techniqueModal.classList.remove('hidden');
                    modalContent.innerHTML = content;
                    startBreathingExercise();
                    break;
                case 'grounding':
                    content = `
                        <h3 class="font-pixel text-2xl text-yellow-400 mb-4">5-4-3-2-1 Grounding</h3>
                        <div id="groundingSteps" class="text-left space-y-3">
                            <p><strong>5:</strong> Name five things you can see.</p>
                            <p><strong>4:</strong> Name four things you can feel.</p>
                            <p><strong>3:</strong> Name three things you can hear.</p>
                            <p><strong>2:</strong> Name two things you can smell.</p>
                            <p><strong>1:</strong> Name one thing you can taste.</p>
                        </div>
                        <button onclick="playSound('click'); performMove(25, 10)" class="btn-modern btn-primary mt-6">Done</button>
                    `;
                    techniqueModal.classList.remove('hidden');
                    modalContent.innerHTML = content;
                    break;
                case 'reframing':
                     content = `
                        <h3 class="font-pixel text-2xl text-yellow-400 mb-4">Mind Shift</h3>
                        <p class="mb-4">Take a negative thought you're having.</p>
                        <textarea id="negativeThoughtInput" class="w-full bg-gray-700 p-2 border-2 border-gray-500 rounded-md" rows="2" placeholder="e.g., 'I will fail this test.'"></textarea>
                        <button id="reframeBtn" onclick="playSound('click'); getReframingSuggestions()" class="btn-modern btn-primary my-4 w-full">✨ Get AI Suggestions</button>
                        <div id="reframedSuggestions" class="text-left text-sm space-y-2 bg-gray-900/50 p-3 rounded-md min-h-[100px]"></div>
                        <button onclick="playSound('click'); performMove(30, 15)" class="btn-modern btn-secondary mt-6">Done</button>
                    `;
                    techniqueModal.classList.remove('hidden');
                    modalContent.innerHTML = content;
                    break;
                case 'tensionTakedown':
                     content = `
                        <h3 class="font-pixel text-2xl text-yellow-400 mb-4">Tension Takedown</h3>
                        <p class="mb-6">Systematically tense for 5s, then release each muscle group.</p>
                        <div class="text-left space-y-2 text-sm">
                            <p><strong>1. Feet & Calves:</strong> Curl your toes, then release.</p>
                            <p><strong>2. Thighs:</strong> Squeeze your thigh muscles, then release.</p>
                            <p><strong>3. Hands & Arms:</strong> Make a fist and flex, then release.</p>
                            <p><strong>4. Shoulders & Neck:</strong> Shrug your shoulders, then release.</p>
                            <p><strong>5. Face:</strong> Scrunch your face, then release.</p>
                        </div>
                        <button onclick="playSound('click'); performMove(35, 20)" class="btn-modern btn-primary mt-6">Complete</button>
                    `;
                    techniqueModal.classList.remove('hidden');
                    modalContent.innerHTML = content;
                    break;
                case 'serenitySanctuary':
                     content = `
                        <h3 class="font-pixel text-2xl text-yellow-400 mb-4">Serenity Sanctuary</h3>
                        <p class="mb-6">Close your eyes. Imagine a place where you feel completely safe and calm. Focus on the details:</p>
                        <ul class="list-disc list-inside text-left mx-auto max-w-xs">
                            <li>What do you see?</li>
                            <li>What do you hear?</li>
                            <li>What do you smell?</li>
                            <li>What do you feel?</li>
                        </ul>
                        <p class="mt-4">Stay there for a few moments.</p>
                        <button onclick="playSound('click'); performMove(40, 25)" class="btn-modern btn-primary mt-6">I'm Back</button>
                    `;
                    techniqueModal.classList.remove('hidden');
                    modalContent.innerHTML = content;
                    break;
            }
        }
        
        function startBreathingExercise() {
            const animator = document.getElementById('breathAnimator');
            const text = document.getElementById('breathText');
            if (!animator || !text) return;
            
            let isModalOpen = true;
            const modalObserver = new MutationObserver(() => {
                if (techniqueModal.classList.contains('hidden')) isModalOpen = false;
            });
            modalObserver.observe(techniqueModal, { attributes: true, attributeFilter: ['class'] });

            let cycle = 0;
            const states = ['Breathe In...', 'Hold...', 'Breathe Out...', 'Hold...'];
            const scales = [1.5, 1.5, 1, 1];

            function runCycle() {
                if (isModalOpen) {
                    text.innerText = states[cycle % 4];
                    animator.style.transform = `scale(${scales[cycle % 4]})`;
                    cycle++;
                    setTimeout(runCycle, 4000);
                }
            }
            
            setTimeout(() => {
                runCycle();
                setTimeout(() => {
                  if (isModalOpen) performMove(20, 5);
                }, 17000);
            }, 1000);
        }

        function closeModal() {
            techniqueModal.classList.add('hidden');
            modalContent.innerHTML = '';
        }
        
        function closeSenseiModal() {
            senseiModal.classList.add('hidden');
            senseiWisdomText.innerHTML = '';
        }

        function giveUp() {
            playSound('lose');
            showScreen('gaveUpScreen');
        }

        function saveReportAndReturn() {
            showScreen('startScreen');
        }

        function exitApp() {
            // This function will only work when the app is running in a Capacitor environment
            try {
                const { App } = Capacitor.Plugins;
                App.exitApp();
            } catch (e) {
                console.log("App.exitApp() is not available in a standard browser.");
                // Fallback for browser (optional: could close window or just do nothing)
            }
        }

        // --- Gemini API Integration ---

        async function callGeminiAPI(userPrompt, systemInstruction) {
            const apiKey = ""; // Leave blank, handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
            };

            try {
                // Exponential backoff
                let response;
                let delay = 1000;
                for (let i = 0; i < 5; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    return "Sorry, I couldn't generate a response. Please try again.";
                }
            } catch (error) {
                console.error("Gemini API call error:", error);
                return "An error occurred while contacting the AI. Please check your connection.";
            }
        }

        async function getReframingSuggestions() {
            const negativeThought = document.getElementById('negativeThoughtInput').value;
            const suggestionsDiv = document.getElementById('reframedSuggestions');
            const reframeBtn = document.getElementById('reframeBtn');

            if (!negativeThought.trim()) {
                suggestionsDiv.innerText = "Please enter a thought first.";
                return;
            }

            reframeBtn.disabled = true;
            reframeBtn.innerHTML = '<span class="loader"></span>';

            const systemInstruction = `You are a compassionate CBT therapist. Your goal is to help a user reframe a negative thought. Provide 3 alternative, balanced perspectives. Keep them short, encouraging, and easy to understand. Do not use jargon. Respond in plain text, with each suggestion starting with a bullet point (•).`;
            
            const aiResponse = await callGeminiAPI(negativeThought, systemInstruction);

            suggestionsDiv.innerHTML = aiResponse.replace(/\•/g, '<p class="mb-1">•');
            reframeBtn.disabled = false;
            reframeBtn.innerHTML = '✨ Get AI Suggestions';
        }
        
        async function getSenseiWisdom(outcome) {
            const trigger = document.getElementById('triggerSelect')?.value || 'an unknown reason';
            senseiModal.classList.remove('hidden');
            senseiWisdomText.innerHTML = '<div class="flex justify-center items-center"><span class="loader"></span></div>';

            const systemInstruction = `You are Sensei Kai, a wise and compassionate martial arts master who teaches students to manage their inner turmoil. Your tone is calm, encouraging, and insightful, like a zen master. Do not use platitudes. Offer a short, single paragraph of wisdom.`;
            
            let userPrompt;
            if (outcome === 'win') {
                userPrompt = `My student just successfully tamed their '${currentOpponentName}' which was triggered by '${trigger}'. Offer them some wisdom about this victory and how to carry this calm forward.`;
            } else { // loss
                userPrompt = `My student felt overwhelmed by their '${currentOpponentName}' and had to retreat. This was triggered by '${trigger}'. Offer them some compassionate wisdom about the importance of rest and the courage it takes to try again.`;
            }
            
            const aiResponse = await callGeminiAPI(userPrompt, systemInstruction);
            senseiWisdomText.innerText = aiResponse;
        }

    </script>
</body>
</html>

