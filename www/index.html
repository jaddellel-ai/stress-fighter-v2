<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
        font-src https://fonts.gstatic.com; 
        img-src 'self' data: https://thesustainabilitymanager.com http://thesustainabilitymanager.com; 
        connect-src https://generativelanguage.googleapis.com;">
    <title>Stress Fighter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --glow-cyan: 0 0 5px #06b6d4, 0 0 10px #06b6d4, 0 0 20px #06b6d4;
            --glow-yellow: 0 0 5px #facc15, 0 0 10px #facc15, 0 0 20px #facc15;
            --glow-red: 0 0 5px #f87171, 0 0 10px #f87171, 0 0 20px #f87171;
            --sf-yellow: #F7D71E;
            --sf-red: #D73B28;
            --sf-blue: #2875D7;
        }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Nunito', sans-serif;
            background: #111827;
            color: #f0f0f0;
            padding-top: env(safe-area-inset-top);
        }
        .font-pixel {
            font-family: 'Press Start 2P', cursive;
        }
        .screen {
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }
        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
        }
        .text-glow-yellow { text-shadow: var(--glow-yellow); }
        .text-glow-cyan { text-shadow: var(--glow-cyan); }
        .btn-modern {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            transform: translateY(0);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-modern:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: all 0.4s;
        }
        .btn-modern:hover:before { left: 100%; }
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-modern:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary {
            background-image: linear-gradient(to right, #2563eb, #3b82f6);
            box-shadow: 0 4px 15px 0 rgba(59, 130, 246, 0.3);
        }
        .btn-secondary {
            background-image: linear-gradient(to right, #4b5563, #6b7280);
            box-shadow: 0 4px 15px 0 rgba(107, 114, 128, 0.3);
        }
        .sf-health-bars {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 8px;
            background: linear-gradient(to bottom, #1f2937, #374151);
            border-bottom: 4px solid #4b5563;
        }
        .sf-bar-container {
            height: 20px;
            width: 40%;
            background-color: #111827;
            border: 2px solid #f0f0f0;
            padding: 2px;
        }
        .sf-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        #composureBar.sf-bar { background-color: var(--sf-yellow); }
        #stressBar.sf-bar { background-color: var(--sf-red); }
        .sf-timer {
            font-family: 'Press Start 2P', cursive;
            color: var(--sf-yellow);
            font-size: 1.5rem;
        }
        .opponent-card {
            background-color: rgba(31, 41, 55, 0.7);
            border: 2px solid #4b5563;
            border-radius: 12px;
            transition: all 0.2s ease-in-out;
            backdrop-filter: blur(4px);
        }
        .opponent-card:hover {
            transform: translateY(-5px);
            border-color: #06b6d4;
            box-shadow: var(--glow-cyan);
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: linear-gradient(135deg, #1f2937, #374151);
            border-radius: 16px;
            border: 2px solid #4b5563;
        }
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .character-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            position: relative; 
        }
        .character-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.2s ease-in-out, opacity 1s ease-in-out;
        }
        .damage-number {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Press Start 2P', cursive;
            font-size: 1.5rem;
            animation: floatUp 1s ease-out forwards;
        }
        .damage-stress { color: var(--sf-red); }
        .damage-composure { color: var(--sf-yellow); }
        .science-text {
            font-size: 0.8rem;
            color: #9ca3af; /* Tailwind gray-400 */
            font-style: italic;
            margin-top: 8px;
            border-left: 2px solid var(--sf-cyan);
            padding-left: 8px;
        }
        .secret-technique-glow {
             box-shadow: var(--glow-yellow);
        }

        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes flash { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(2); } }
        @keyframes floatUp { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -50px); } }
        @keyframes tranquil-glow { 
            from { filter: brightness(1) drop-shadow(0 0 0 white); } 
            50% { filter: brightness(1.5) drop-shadow(0 0 10px white); }
            to { filter: brightness(1) drop-shadow(0 0 0 white); }
        }
        .tranquil-sequence { animation: tranquil-glow 2s ease-out forwards; }
    </style>
</head>
<body class="w-full h-screen flex items-center justify-center">

    <div id="screenContainer" class="w-full h-full flex items-center justify-center bg-gray-900">
    
        <div id="splashScreen" class="screen bg-gray-900 cursor-pointer" onclick="initApp()">
            <h1 class="font-pixel text-4xl md:text-5xl text-yellow-400 text-glow-yellow mb-4 text-center">Stress Fighter I</h1>
            <img src="http://thesustainabilitymanager.com/launch.png" alt="Stress Fighter Launch Image" class="max-w-xs md:max-w-md mx-auto">
            <p class="text-lg text-cyan-400 text-glow-cyan mt-8 animate-pulse">Tap to Start</p>
        </div>

        <div id="startScreen" class="screen hidden">
            <h1 class="font-pixel text-4xl md:text-6xl text-yellow-400 text-glow-yellow mb-4 text-center">Stress Fighter</h1>
            <p class="text-lg text-cyan-400 text-glow-cyan mb-8 text-center">Get a grip on chaos.</p>
            <div id="dailySecretContainer" class="text-center mb-6 hidden">
                <p class="text-yellow-400 font-bold">Sensei's Secret Technique:</p>
                <p id="dailySecretText" class="text-lg text-glow-yellow"></p>
            </div>
            <div class="space-y-4 flex flex-col items-center">
                <button onclick="playSound('click'); showScreen('selectOpponentScreen')" class="btn-modern btn-primary w-64">Start Fight</button>
                <button onclick="playSound('click'); showHowToPlay()" class="btn-modern btn-secondary w-64">How to Play</button>
                <button onclick="playSound('click'); exitApp()" class="btn-modern btn-secondary w-64 bg-gray-700">Quit App</button>
            </div>
        </div>

        <div id="selectOpponentScreen" class="screen hidden">
             <h2 class="font-pixel text-2xl md:text-3xl text-yellow-400 text-glow-yellow mb-6 text-center">Choose Your Opponent</h2>
             <p class="mb-8 text-cyan-400 text-center">What does your stress feel like today?</p>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl">
                <div onclick="playSound('click'); selectOpponent('anxiety')" class="opponent-card p-4 cursor-pointer">
                    <div class="monster-container h-32 flex items-center justify-center"></div>
                    <h3 class="font-pixel text-xl text-red-400 mt-4">Anxious Assassin</h3>
                    <p class="text-sm mt-2 text-gray-300">Racing thoughts & worry about the future.</p>
                </div>
                <div onclick="playSound('click'); selectOpponent('burnout')" class="opponent-card p-4 cursor-pointer">
                    <div class="monster-container h-32 flex items-center justify-center"></div>
                    <h3 class="font-pixel text-xl text-red-400 mt-4">Exhausted Brute</h3>
                    <p class="text-sm mt-2 text-gray-300">Heavy exhaustion & emotional depletion.</p>
                </div>
                <div onclick="playSound('click'); selectOpponent('anger')" class="opponent-card p-4 cursor-pointer">
                    <div class="monster-container h-32 flex items-center justify-center"></div>
                    <h3 class="font-pixel text-xl text-red-400 mt-4">Raging Brawler</h3>
                    <p class="text-sm mt-2 text-gray-300">Frustration, irritation & explosive feelings.</p>
                </div>
            </div>
            <button onclick="playSound('click'); showScreen('startScreen')" class="btn-modern btn-secondary mt-12">Back</button>
        </div>

        <div id="arenaScreen" class="screen hidden !justify-start p-0">
            <div class="sf-health-bars">
                <div class="sf-bar-container">
                    <div id="composureBar" class="sf-bar" style="width: 100%;"></div>
                </div>
                <div class="sf-timer">VS</div>
                <div class="sf-bar-container">
                    <div id="stressBar" class="sf-bar" style="width: 100%;"></div>
                </div>
            </div>
            <div class="flex-grow flex justify-between items-center bg-gray-800 p-2 md:p-6 w-full">
                <div id="playerCharacter" class="character-container w-1/2 h-full"></div>
                <div id="monsterCharacter" class="character-container w-1/2 h-full"></div>
            </div>
            <div id="moveList" class="grid grid-cols-3 gap-2 w-full p-2 bg-gray-900">
                <button id="tech-zenBreath" onclick="playSound('click'); showTechnique('zenBreath')" class="btn-modern btn-secondary text-xs p-2">Zen Breath</button>
                <button id="tech-grounding" onclick="playSound('click'); showTechnique('grounding')" class="btn-modern btn-secondary text-xs p-2">5-4-3-2-1</button>
                <button id="tech-reframing" onclick="playSound('click'); showTechnique('reframing')" class="btn-modern btn-secondary text-xs p-2">Mind Shift</button>
                <button id="tech-tensionTakedown" onclick="playSound('click'); showTechnique('tensionTakedown')" class="btn-modern btn-secondary text-xs p-2">Tension Takedown</button>
                <button id="tech-serenitySanctuary" onclick="playSound('click'); showTechnique('serenitySanctuary')" class="btn-modern btn-secondary text-xs p-2">Serenity Sanctuary</button>
                <button onclick="playSound('click'); takeABreak()" class="btn-modern bg-yellow-600 hover:bg-yellow-500 text-xs p-2">Take a Break</button>
            </div>
        </div>

        <div id="victoryScreen" class="screen hidden">
            <h2 class="font-pixel text-4xl text-yellow-400 text-glow-yellow mb-6">TRANQUILITY</h2>
            <div id="tamedMonsterContainer" class="h-48 w-48 mx-auto my-4 character-container"></div>
            <p class="text-cyan-400 mb-8">You have calmed the storm. The stress is now at peace.</p>
            <div id="strategyLog" class="w-full max-w-md mx-auto mt-8 text-left">
                <h3 class="font-pixel text-lg text-yellow-400 mb-4 text-center">Post-Fight Strategy Log</h3>
                
                <label for="triggerInput" class="text-sm mb-2 block text-center">What was the specific trigger for this feeling?</label>
                <input type="text" id="triggerInput" class="w-full p-2 bg-gray-700 border-2 border-gray-500 text-white mb-4 rounded-md" placeholder="e.g., A deadline at work...">
                
                <label for="intensitySlider" class="text-sm mb-2 block text-center">How intense was it at the start? <span id="intensityValue">5</span>/10</label>
                <input type="range" id="intensitySlider" min="1" max="10" value="5" class="w-full mb-4">

                <label for="strategyInput" class="text-sm mb-2 block text-center">What is one small action you can take to prepare for this trigger next time?</label>
                <textarea id="strategyInput" class="w-full p-2 bg-gray-700 border-2 border-gray-500 text-white mb-4 rounded-md" rows="2" placeholder="e.g., I will take a 5-minute walk..."></textarea>

                <button onclick="playSound('click'); getSenseiFeedback('win')" class="btn-modern btn-primary w-full mb-2">✨ Get Sensei's Feedback</button>
                <button onclick="playSound('click'); saveReportAndReturn()" class="btn-modern btn-secondary w-full">Save & Return to Menu</button>
            </div>
        </div>
        <div id="gaveUpScreen" class="screen hidden">
            <h2 class="font-pixel text-4xl text-red-500" style="text-shadow: var(--glow-red);">OVERWHELMED</h2>
            <p class="text-cyan-400 mb-8">It's okay to retreat. Rest and try again when you're ready.</p>
            <button onclick="playSound('click'); getSenseiFeedback('loss')" class="btn-modern btn-primary w-64 mb-2">✨ Get Sensei's Wisdom</button>
            <button onclick="playSound('click'); showScreen('startScreen')" class="btn-modern btn-secondary w-64">Return to Menu</button>
        </div>
    </div>
    
    <div id="techniqueModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div id="modalContent" class="modal-content w-11/12 max-w-lg text-center relative p-8"></div>
    </div>
    
    <div id="senseiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="modal-content w-11/12 max-w-lg text-center relative p-8">
            <h3 id="senseiModalTitle" class="font-pixel text-2xl text-yellow-400 mb-4">Sensei's Wisdom</h3>
            <div id="senseiWisdomText" class="text-cyan-300 min-h-[100px]"></div>
            <button onclick="playSound('click'); closeSenseiModal()" class="btn-modern btn-secondary mt-6">Close</button>
        </div>
    </div>
    
    <script>
        // --- DOM element references ---
        const screenContainer = document.getElementById('screenContainer');
        const techniqueModal = document.getElementById('techniqueModal');
        const modalContent = document.getElementById('modalContent');
        const senseiModal = document.getElementById('senseiModal');
        const senseiModalTitle = document.getElementById('senseiModalTitle');
        const senseiWisdomText = document.getElementById('senseiWisdomText');
        const composureBar = document.getElementById('composureBar');
        const stressBar = document.getElementById('stressBar');
        const playerCharacter = document.getElementById('playerCharacter');
        const monsterCharacter = document.getElementById('monsterCharacter');
        const intensitySlider = document.getElementById('intensitySlider');
        const intensityValue = document.getElementById('intensityValue');
        const dailySecretContainer = document.getElementById('dailySecretContainer');
        const dailySecretText = document.getElementById('dailySecretText');

        // --- State variables ---
        let stressLevel = 100, composureLevel = 100;
        let currentOpponent = '', currentScreen = 'splashScreen', currentOpponentName = '';
        let audioStarted = false, appInitialized = false;
        let secretTechnique = { id: '', name: '' };

        const characterImages = {
            player: 'https://thesustainabilitymanager.com/player.png',
            anxiety: 'https://thesustainabilitymanager.com/anxious%20assassin.png',
            burnout: 'https://thesustainabilitymanager.com/Exhauster%20brute.png',
            anger: 'https://thesustainabilitymanager.com/Raging%20brawler.png',
            'player-victory': 'https://thesustainabilitymanager.com/player-victory.png',
            'anxiety-calm': 'https://thesustainabilitymanager.com/anxious-assassin-calm.png',
            'burnout-calm': 'https://thesustainabilitymanager.com/exhauster-brute-calm.png',
            'anger-calm': 'https://thesustainabilitymanager.com/raging-brawler-calm.png'
        };
        const opponentNames = { anxiety: "Anxious Assassin", burnout: "Exhausted Brute", anger: "Raging Brawler" };
        const techniques = [
            { id: 'zenBreath', name: 'Zen Breath' },
            { id: 'grounding', name: '5-4-3-2-1' },
            { id: 'reframing', name: 'Mind Shift' },
            { id: 'tensionTakedown', name: 'Tension Takedown' },
            { id: 'serenitySanctuary', name: 'Serenity Sanctuary' }
        ];

        // --- Audio Setup ---
        const sounds = {
            'click': new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
            'hit': new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: 'exponential' } }).toDestination(),
            'win': new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.5, release: 1 } }).toDestination(),
            'lose': new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.2, release: 1 } }).toDestination()
        };
        const tenseAmbience = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 5, decay: 0.1, sustain: 1 } }).toDestination();
        tenseAmbience.volume.value = -40; // very quiet
        const calmAmbience = new Tone.Synth({ oscillator: { type: 'fatsine' }, envelope: { attack: 5, decay: 0.1, sustain: 1 } }).toDestination();
        calmAmbience.volume.value = -40;

        function updateAmbience() {
            if (!audioStarted) return;
            if (stressLevel > 70) {
                tenseAmbience.triggerAttack();
                calmAmbience.triggerRelease();
            } else if (stressLevel < 30) {
                tenseAmbience.triggerRelease();
                calmAmbience.triggerAttack('C2');
            } else {
                tenseAmbience.triggerRelease();
                calmAmbience.triggerRelease();
            }
        }

        function setSecretTechnique() {
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const tech = techniques[dayOfYear % techniques.length];
            secretTechnique = tech;
            dailySecretText.textContent = tech.name;
            dailySecretContainer.classList.remove('hidden');
        }

        function initApp() {
            if (appInitialized) return;
            appInitialized = true;
            showScreen('startScreen');
            setSecretTechnique();
            Tone.start().then(() => { 
                audioStarted = true;
                tenseAmbience.toDestination();
                calmAmbience.toDestination();
             }).catch(e => console.error("Audio could not be started:", e));
        }

        function playSound(sound) {
            if (!audioStarted) { initApp(); return; }
            switch(sound) {
                case 'click': sounds.click.triggerAttackRelease('C4', '8n'); break;
                case 'hit': sounds.hit.triggerAttackRelease('C2', '8n'); break;
                case 'win':
                    sounds.win.triggerAttackRelease('C5', '8n', Tone.now());
                    sounds.win.triggerAttackRelease('E5', '8n', Tone.now() + 0.2);
                    sounds.win.triggerAttackRelease('G5', '8n', Tone.now() + 0.4);
                    break;
                case 'lose': sounds.lose.triggerAttackRelease('C3', '4n'); break;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            playerCharacter.innerHTML = `<img src="${characterImages.player}" class="character-img" alt="Player Character">`;
            document.querySelectorAll('#selectOpponentScreen .monster-container').forEach(container => {
                const card = container.closest('.opponent-card');
                let opponentType = '';
                if (card.onclick.toString().includes('anxiety')) opponentType = 'anxiety';
                else if (card.onclick.toString().includes('burnout')) opponentType = 'burnout';
                else if (card.onclick.toString().includes('anger')) opponentType = 'anger';
                if (opponentType) container.innerHTML = `<img src="${characterImages[opponentType]}" class="character-img" alt="${opponentNames[opponentType]}">`;
            });
            intensitySlider.addEventListener('input', (event) => {
                intensityValue.textContent = event.target.value;
            });
        });

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            currentScreen = screenId;
        }

        function selectOpponent(opponentType) {
            currentOpponent = opponentType;
            currentOpponentName = opponentNames[opponentType];
            
            playerCharacter.innerHTML = `<img src="${characterImages.player}" class="character-img" alt="Player Character">`;
            monsterCharacter.innerHTML = `<img src="${characterImages[opponentType]}" class="character-img" alt="${opponentNames[opponentType]}">`;
            
            document.querySelectorAll('#moveList button').forEach(btn => btn.classList.remove('secret-technique-glow'));
            document.getElementById(`tech-${secretTechnique.id}`)?.classList.add('secret-technique-glow');

            stressLevel = 100; composureLevel = 100;
            updateBars();
            showScreen('arenaScreen');
        }
        
        function showImpact(target, value) {
            const container = target === 'player' ? playerCharacter : monsterCharacter;
            const characterImg = container.querySelector('.character-img');
            const damageNumber = document.createElement('div');
            if (target === 'player') {
                damageNumber.className = 'damage-number damage-composure';
                damageNumber.textContent = `+${Math.round(value)}`;
                characterImg.classList.add('flash-effect');
            } else {
                damageNumber.className = 'damage-number damage-stress';
                damageNumber.textContent = `-${Math.round(value)}`;
                characterImg.classList.add('shake-effect');
            }
            container.appendChild(damageNumber);
            setTimeout(() => {
                damageNumber.remove();
                characterImg.classList.remove('shake-effect', 'flash-effect');
            }, 1000);
        }

        function triggerFinishingMove() {
            playSound('win');
            document.getElementById('moveList').style.pointerEvents = 'none';
            const monsterImg = monsterCharacter.querySelector('.character-img');
            const playerImg = playerCharacter.querySelector('.character-img');

            monsterImg.src = characterImages[`${currentOpponent}-calm`];
            playerImg.src = characterImages['player-victory'];
            
            monsterImg.classList.add('tranquil-sequence');

            setTimeout(() => {
                document.getElementById('tamedMonsterContainer').innerHTML = `<img src="${characterImages[currentOpponent + '-calm']}" class="character-img" alt="${opponentNames[currentOpponent]} Tamed">`;
                showScreen('victoryScreen');
                document.getElementById('moveList').style.pointerEvents = 'auto';
            }, 2500);
        }

        function updateBars(isFinalMove = false) {
            stressLevel = Math.max(0, stressLevel);
            composureLevel = Math.min(100, composureLevel);
            stressBar.style.width = `${stressLevel}%`;
            composureBar.style.width = `${composureLevel}%`;
            updateAmbience();

            if (isFinalMove && stressLevel <= 0) {
                triggerFinishingMove();
            }
        }

        function completeMove(damage, composureBoost, techniqueId) {
            if (techniqueId === secretTechnique.id) {
                damage *= 1.5;
                composureBoost *= 1.5;
            }

            playSound('hit');
            showImpact('monster', damage);
            showImpact('player', composureBoost);
            
            const isFinalMove = (stressLevel - damage) <= 0;
            stressLevel -= damage;
            composureLevel += composureBoost;

            setTimeout(() => updateBars(isFinalMove), 300);
            closeModal();
        }

        function showFeelingCheckIn(damage, composureBoost, techniqueId) {
             modalContent.innerHTML = `
                <h3 class="font-pixel text-2xl text-yellow-400 mb-4">Check In</h3>
                <p class="mb-6 text-lg">Take a breath. Notice how you feel after that exercise.</p>
                <button onclick="completeMove(${damage}, ${composureBoost}, '${techniqueId}')" class="btn-modern btn-primary mt-6">Continue</button>
            `;
        }
        
        function startGroundingExercise() {
            const steps = [
                "<strong>5:</strong> Name five things you can <strong>see</strong> around you.",
                "<strong>4:</strong> Name four things you can <strong>feel</strong> (e.g., your feet on the floor).",
                "<strong>3:</strong> Name three things you can <strong>hear</strong> right now.",
                "<strong>2:</strong> Name two things you can <strong>smell</strong>.",
                "<strong>1:</strong> Name one thing you can <strong>taste</strong>."
            ];
            let currentStep = 0;
            function updateStep() {
                if (currentStep < steps.length) {
                    modalContent.innerHTML = `
                        <h3 class="font-pixel text-2xl text-yellow-400 mb-4">5-4-3-2-1 Grounding</h3>
                        <p class="mb-6 text-lg">${steps[currentStep]}</p>
                        <button onclick="nextGroundingStep()" class="btn-modern btn-primary mt-6">Next</button>`;
                } else {
                    showFeelingCheckIn(25, 10, 'grounding');
                }
            }
            window.nextGroundingStep = () => { currentStep++; updateStep(); };
            updateStep();
        }

        function showTechnique(techniqueId) {
            let content = '';
            techniqueModal.classList.remove('hidden');
            switch (techniqueId) {
                case 'zenBreath':
                    content = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">Zen Breath</h3>
                        <p class="mb-6">Follow the rhythm. Breathe in, hold, breathe out, hold.</p>
                        <div id="breathAnimator" class="w-24 h-24 bg-cyan-400 mx-auto rounded-full transition-transform duration-[4000ms] ease-in-out"></div>
                        <p id="breathText" class="mt-4 text-lg">Get Ready...</p>
                        <button onclick="playSound('click'); closeModal()" class="btn-modern btn-secondary mt-6">Cancel</button>`;
                    modalContent.innerHTML = content;
                    startBreathingExercise();
                    break;
                case 'grounding': startGroundingExercise(); break;
                case 'reframing':
                     content = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">Mind Shift</h3>
                        <p class="mb-4">Take a negative thought you're having.</p>
                        <textarea id="negativeThoughtInput" class="w-full bg-gray-700 p-2 border-2 border-gray-500 rounded-md" rows="2" placeholder="e.g., 'I will fail this test.'"></textarea>
                        <button id="reframeBtn" onclick="playSound('click'); getReframingSuggestions()" class="btn-modern btn-primary my-4 w-full">✨ Get AI Suggestions</button>
                        <div id="reframedSuggestions" class="text-left text-sm space-y-2 bg-gray-900/50 p-3 rounded-md min-h-[100px]"></div>
                        <button onclick="showFeelingCheckIn(30, 15, 'reframing')" class="btn-modern btn-secondary mt-6">Done</button>`;
                    modalContent.innerHTML = content;
                    break;
                case 'tensionTakedown':
                     content = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">Tension Takedown</h3>
                        <p class="mb-6">Systematically tense for 5s, then release each muscle group.</p>
                        <div class="text-left space-y-2 text-sm">
                            <p><strong>1. Feet & Calves:</strong> Curl your toes, then release.</p>
                            <p><strong>2. Thighs:</strong> Squeeze your thigh muscles, then release.</p>
                            <p><strong>3. Hands & Arms:</strong> Make a fist and flex, then release.</p>
                            <p><strong>4. Shoulders & Neck:</strong> Shrug your shoulders, then release.</p>
                            <p><strong>5. Face:</strong> Scrunch your face, then release.</p>
                        </div>
                        <button onclick="showFeelingCheckIn(35, 20, 'tensionTakedown')" class="btn-modern btn-primary mt-6">Complete</button>`;
                    modalContent.innerHTML = content;
                    break;
                case 'serenitySanctuary':
                     content = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">Serenity Sanctuary</h3>
                        <p class="mb-6">Close your eyes. Imagine a place where you feel completely safe and calm...</p>
                        <ul class="list-disc list-inside text-left mx-auto max-w-xs">
                            <li>What do you see?</li>
                            <li>What do you hear?</li>
                            <li>What do you smell?</li>
                            <li>What do you feel?</li>
                        </ul>
                        <button onclick="showFeelingCheckIn(40, 25, 'serenitySanctuary')" class="btn-modern btn-primary mt-6">I'm Back</button>`;
                    modalContent.innerHTML = content;
                    break;
            }
        }
        
        function startBreathingExercise() {
            const animator = document.getElementById('breathAnimator');
            const text = document.getElementById('breathText');
            if (!animator || !text) return;
            let isModalOpen = true;
            const modalObserver = new MutationObserver(() => {
                if (techniqueModal.classList.contains('hidden')) isModalOpen = false;
            });
            modalObserver.observe(techniqueModal, { attributes: true, attributeFilter: ['class'] });
            let cycle = 0;
            const states = ['Breathe In...', 'Hold...', 'Breathe Out...', 'Hold...'];
            const scales = [1.5, 1.5, 1, 1];
            function runCycle() {
                if (isModalOpen) {
                    text.innerText = states[cycle % 4];
                    animator.style.transform = `scale(${scales[cycle % 4]})`;
                    cycle++;
                    setTimeout(runCycle, 4000);
                }
            }
            setTimeout(() => {
                if (!techniqueModal.classList.contains('hidden')) {
                    runCycle();
                    setTimeout(() => {
                      if (!techniqueModal.classList.contains('hidden')) showFeelingCheckIn(20, 5, 'zenBreath');
                    }, 17000);
                }
            }, 1000); 
        }

        function closeModal() {
            techniqueModal.classList.add('hidden');
            modalContent.innerHTML = '';
        }
        
        function closeSenseiModal() { senseiModal.classList.add('hidden'); senseiWisdomText.innerHTML = ''; }

        function takeABreak() {
            modalContent.innerHTML = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">Take a Break?</h3>
                <p class="mb-6">It's okay to step away and return when you're ready. Would you like to end this session for now?</p>
                <div class="flex justify-center gap-4">
                    <button onclick="playSound('click'); closeModal()" class="btn-modern btn-secondary">Stay</button>
                    <button onclick="playSound('lose'); showScreen('gaveUpScreen'); closeModal();" class="btn-modern btn-primary">End Session</button>
                </div>`;
            techniqueModal.classList.remove('hidden');
        }
        
        function showHowToPlay() {
             modalContent.innerHTML = `<h3 class="font-pixel text-2xl text-yellow-400 mb-4">How to Play</h3>
                <div class="text-left space-y-4">
                  <p>1. Identify your feeling and choose the corresponding Opponent.</p>
                  <p>2. Your <span class="text-yellow-400">Composure</span> is top left; the <span class="text-red-400">Stress</span> level is top right.</p>
                  <p>3. Use the techniques as your moves. Each is a real exercise to lower Stress and raise Composure.</p>
                  <p>4. Your goal is to lower the Stress level to zero to find Tranquility.</p>
                </div>
                <button onclick="playSound('click'); closeModal()" class="btn-modern btn-secondary mt-6">Got It</button>`;
            techniqueModal.classList.remove('hidden');
        }

        function saveReportAndReturn() {
            const trigger = document.getElementById('triggerInput').value;
            const intensity = document.getElementById('intensitySlider').value;
            const strategy = document.getElementById('strategyInput').value;
            console.log('Session Logged:', { opponent: currentOpponentName, trigger, intensity, strategy });
            showScreen('startScreen');
        }

        function exitApp() {
            try { Capacitor.Plugins.App.exitApp(); } catch (e) { console.log("ExitApp not available in browser."); }
        }

        async function callGeminiAPI(userPrompt, systemInstruction) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 20000); 
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal 
                });
                clearTimeout(timeoutId); 
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.status}`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    if (candidate && candidate.finishReason === 'SAFETY') {
                        return "The response was blocked for safety reasons. Please try a different prompt.";
                    }
                    return "Sorry, I couldn't generate a response. Please try again.";
                }
            } catch (error) {
                console.error("Gemini API call error:", error);
                if (error.name === 'AbortError') {
                    return "The request timed out. Please check your connection and try again.";
                }
                return "An error occurred while contacting the AI. Please check your connection.";
            }
        }

        async function getReframingSuggestions() {
            const negativeThought = document.getElementById('negativeThoughtInput').value;
            const suggestionsDiv = document.getElementById('reframedSuggestions');
            const reframeBtn = document.getElementById('reframeBtn');
            if (!negativeThought.trim()) {
                suggestionsDiv.innerText = "Please enter a thought first.";
                return;
            }
            reframeBtn.disabled = true;
            reframeBtn.innerHTML = '<span class="loader"></span>';
            try {
                const systemInstruction = `You are a compassionate CBT therapist. Your goal is to help a user reframe a negative thought. Provide 3 alternative, balanced perspectives. Keep them short, encouraging, and easy to understand. Do not use jargon. Respond in plain text, with each suggestion starting with a bullet point (•).`;
                const aiResponse = await callGeminiAPI(negativeThought, systemInstruction);
                suggestionsDiv.innerHTML = aiResponse.replace(/\•/g, '<p class="mb-1">•');
            } catch (error) {
                console.error("Error in getReframingSuggestions:", error);
                suggestionsDiv.innerText = "An unexpected error occurred while getting suggestions.";
            } finally {
                reframeBtn.disabled = false;
                reframeBtn.innerHTML = '✨ Get AI Suggestions';
            }
        }
        
        async function getSenseiFeedback(outcome) {
            const trigger = document.getElementById('triggerInput')?.value || 'an unknown reason';
            const strategy = document.getElementById('strategyInput')?.value;
            senseiModal.classList.remove('hidden');
            senseiWisdomText.innerHTML = '<div class="flex justify-center items-center"><span class="loader"></span></div>';
            
            try {
                const systemInstruction = `You are Sensei Kai, a wise and compassionate martial arts master who teaches students to manage their inner turmoil. Your tone is calm, encouraging, and insightful, like a zen master. Do not use platitudes. Offer a short, single paragraph of wisdom.`;
                
                let userPrompt;
                if (outcome === 'win') {
                    senseiModalTitle.innerText = "Sensei's Feedback";
                    userPrompt = `My student just successfully calmed their '${currentOpponentName}' which was triggered by '${trigger}'. They have proposed a strategy for next time: '${strategy}'. Please validate their strategy and offer a short, encouraging piece of wisdom about their progress. If they didn't enter a strategy, just give general wisdom.`;
                } else { // loss
                    senseiModalTitle.innerText = "Sensei's Wisdom";
                    userPrompt = `My student felt overwhelmed by their '${currentOpponentName}'. Offer them some compassionate wisdom about the importance of rest and the courage it takes to try again.`;
                }
                
                const aiResponse = await callGeminiAPI(userPrompt, systemInstruction);
                senseiWisdomText.innerText = aiResponse;
            } catch (error) {
                console.error("Error in getSenseiFeedback:", error);
                senseiWisdomText.innerText = "An unexpected error occurred. Please try again.";
            }
        }
    </script>
</body>
</html>

